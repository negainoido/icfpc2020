steps:

# https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/cache
- name: 'gcr.io/$PROJECT_ID/restore_cache'
  waitFor: ['-']
  args:
  - '--bucket=gs://$_CACHE_BUCKET'
  - '--key=cargo-home-$( checksum Cargo.lock )'
  id: 'cargo-home'

# https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/cache
- name: 'gcr.io/$PROJECT_ID/restore_cache'
  waitFor: ['-']
  args:
  - '--bucket=gs://$_CACHE_BUCKET'
  - '--key=cargo-target-$( checksum Cargo.lock )'
  id: 'cargo-target'

# from https://hub.docker.com/_/rust
- name: 'rust:slim-stretch'
  args: ['cargo', 'build']
  waitFor: ['cargo-home', 'cargo-target']
  id: 'cargo-build'

# from https://hub.docker.com/_/rust
- name: 'rust:slim-stretch'
  args: ['cargo', 'test']
  waitFor: ['cargo-build']
  id: 'cargo-test'

# https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/cache
- name: 'gcr.io/$PROJECT_ID/save_cache'
  args:
  - '--bucket=gs://$_CACHE_BUCKET'
  - '--key=cargo-home-$( checksum Cargo.lock )'
  # https://doc.rust-lang.org/cargo/guide/cargo-home.html#caching-the-cargo-home-in-ci
  - '--path=cargo_home/bin'
  - '--path=cargo_home/registry/index'
  - '--path=cargo_home/registry/cache'
  - '--path=cargo_home/git/db'
  - '--no-clobber'
  waitFor: ['cargo-test']

# https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/cache
- name: 'gcr.io/$PROJECT_ID/save_cache'
  args:
  - '--bucket=gs://$_CACHE_BUCKET'
  - '--key=cargo-target-$( checksum Cargo.lock )'
  # https://doc.rust-lang.org/cargo/guide/build-cache.html
  - '--path=target'
  waitFor: ['cargo-test']


options:
  env:
    - 'CARGO_HOME=/workspace/cargo_home'


substitutions:
  _CACHE_BUCKET: negainoido-icfpc-2020_cloudbuild
